<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Apps Script API - TFI</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 0;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #2980b9;
        }
        button.delete-btn {
            background: #e74c3c;
        }
        button.delete-btn:hover {
            background: #c0392b;
        }
        button.get-btn {
            background: #27ae60;
        }
        button.get-btn:hover {
            background: #229954;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .inline-group {
            display: flex;
            gap: 10px;
        }
        .inline-group .form-group {
            flex: 1;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            color: #e83e8c;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Apps Script API Endpoints</h1>
    
    <div class="test-section">
        <h2>üìã API Configuration</h2>
        <p><strong>Base URL:</strong> <code id="base-url">https://script.google.com/macros/s/AKfycbzxNlvzyCsbIng-4rhwzdz6Y9lWyJL9J9gCG25qtjPQ1Zjra9h76qAZMcynqMcR3w8k/exec</code></p>
        <p><strong>API Key:</strong> <code id="api-key">3a28a55b9fcabc0f5d46c0139b4f1f23919cbcc46718ef12</code></p>
    </div>

    <!-- GET MATCHES -->
    <div class="test-section">
        <h2>‚öΩ 1. GET Matches (All Items)</h2>
        <p>Test loading all matches with date and kickoff fields</p>
        <button class="get-btn" onclick="testGetMatches()">üîç GET Matches</button>
        <div id="matches-result" class="result" style="display:none;"></div>
    </div>

    <!-- GET APPROVED LEAGUES -->
    <div class="test-section">
        <h2>üèÜ 2. GET Approved_Leagues (All Items)</h2>
        <p>Test loading all approved leagues with country information</p>
        <button class="get-btn" onclick="testGetApprovedLeagues()">üîç GET Approved_Leagues</button>
        <div id="approved-leagues-result" class="result" style="display:none;"></div>
    </div>

    <!-- GET WATCHLIST -->
    <div class="test-section">
        <h2>‚úÖ 3. GET Watchlist (All Items)</h2>
        <p>Test loading all watchlist items</p>
        <button class="get-btn" onclick="testGetWatchlist()">üîç GET Watchlist</button>
        <div id="get-result" class="result" style="display:none;"></div>
    </div>

    <!-- ADD TO WATCHLIST -->
    <div class="test-section">
        <h2>‚ûï 4. ADD to Watchlist (Create)</h2>
        <p>Test adding a new item to watchlist</p>
        
        <div class="inline-group">
            <div class="form-group">
                <label>Match ID:</label>
                <input type="text" id="add-match-id" value="TEST123" placeholder="e.g., 1379087">
            </div>
            <div class="form-group">
                <label>Date:</label>
                <input type="text" id="add-date" value="2025-11-26" placeholder="YYYY-MM-DD">
            </div>
        </div>

        <div class="inline-group">
            <div class="form-group">
                <label>League:</label>
                <input type="text" id="add-league" value="Premier League" placeholder="League name">
            </div>
            <div class="form-group">
                <label>Kickoff:</label>
                <input type="text" id="add-kickoff" value="20:00" placeholder="HH:MM">
            </div>
        </div>

        <div class="inline-group">
            <div class="form-group">
                <label>Home Team:</label>
                <input type="text" id="add-home" value="Man City" placeholder="Home team">
            </div>
            <div class="form-group">
                <label>Away Team:</label>
                <input type="text" id="add-away" value="Liverpool" placeholder="Away team">
            </div>
        </div>

        <div class="inline-group">
            <div class="form-group">
                <label>Mode:</label>
                <input type="text" id="add-mode" value="LIVE" placeholder="LIVE, B, etc.">
            </div>
            <div class="form-group">
                <label>Priority:</label>
                <input type="number" id="add-priority" value="3" placeholder="1-5">
            </div>
        </div>

        <div class="form-group">
            <label>Custom Conditions:</label>
            <textarea id="add-conditions" rows="2" placeholder="Optional custom conditions"></textarea>
        </div>

        <button onclick="testAddWatchlist()">‚ûï ADD to Watchlist</button>
        <div id="add-result" class="result" style="display:none;"></div>
    </div>

    <!-- DELETE FROM WATCHLIST -->
    <div class="test-section">
        <h2>üóëÔ∏è 5. DELETE from Watchlist</h2>
        <p>Test deleting items by match_id (comma-separated for multiple)</p>
        
        <div class="form-group">
            <label>Match IDs to Delete (comma-separated):</label>
            <input type="text" id="delete-ids" value="TEST123" placeholder="e.g., 1379087, 1379088">
        </div>

        <button class="delete-btn" onclick="testDeleteWatchlist()">üóëÔ∏è DELETE from Watchlist</button>
        <div id="delete-result" class="result" style="display:none;"></div>
    </div>

    <!-- BATCH OPERATIONS -->
    <div class="test-section">
        <h2>üîÑ 6. Batch Operations</h2>
        <p>Quick test scenarios</p>
        <button class="get-btn" onclick="runFullTest()">üöÄ Run Full Test (GET ‚Üí ADD ‚Üí GET ‚Üí DELETE ‚Üí GET)</button>
        <div id="batch-result" class="result" style="display:none;"></div>
    </div>

    <script>
        const BASE_URL = 'https://script.google.com/macros/s/AKfycbzxNlvzyCsbIng-4rhwzdz6Y9lWyJL9J9gCG25qtjPQ1Zjra9h76qAZMcynqMcR3w8k/exec';
        const API_KEY = '3a28a55b9fcabc0f5d46c0139b4f1f23919cbcc46718ef12';

        function showResult(elementId, data, isError = false) {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.className = 'result ' + (isError ? 'error' : 'success');
            el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        }

        function showInfo(elementId, data) {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.className = 'result info';
            el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        }

        async function testGetMatches() {
            try {
                showInfo('matches-result', '‚è≥ Loading matches...');
                
                const url = new URL(BASE_URL);
                url.searchParams.set('resource', 'matches');
                url.searchParams.set('action', 'getAll');
                url.searchParams.set('apiKey', API_KEY);

                console.log('GET MATCHES Request URL:', url.toString());

                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'omit',
                    redirect: 'follow'
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);

                // Show sample of first 3 matches with date and kickoff details
                let displayData = {
                    status: response.status,
                    statusText: response.statusText,
                    totalCount: result.items?.length || 0,
                    resource: result.resource,
                    action: result.action
                };

                if (result.items && result.items.length > 0) {
                    displayData.sampleMatches = result.items.slice(0, 3).map(m => ({
                        match_id: m.match_id,
                        date: m.date,
                        kickoff: m.kickoff,
                        kickoff_type: typeof m.kickoff,
                        league: m.league_name || m.league,
                        match: `${m.home_team} vs ${m.away_team}`
                    }));
                }

                showResult('matches-result', displayData);
            } catch (error) {
                console.error('GET MATCHES Error:', error);
                showResult('matches-result', {
                    error: error.message,
                    stack: error.stack
                }, true);
            }
        }

        async function testGetApprovedLeagues() {
            try {
                showInfo('approved-leagues-result', '‚è≥ Loading approved leagues...');
                
                const url = new URL(BASE_URL);
                url.searchParams.set('resource', 'approved_leagues');
                url.searchParams.set('action', 'getAll');
                url.searchParams.set('apiKey', API_KEY);

                console.log('GET APPROVED_LEAGUES Request URL:', url.toString());

                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'omit',
                    redirect: 'follow'
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);

                // Show sample of first 10 leagues with all details
                let displayData = {
                    status: response.status,
                    statusText: response.statusText,
                    totalCount: result.items?.length || 0,
                    resource: result.resource,
                    action: result.action
                };

                if (result.items && result.items.length > 0) {
                    displayData.sampleLeagues = result.items.slice(0, 10).map(l => ({
                        league_id: l.league_id,
                        league_name: l.league_name,
                        country: l.country,
                        tier: l.tier,
                        active: l.active,
                        type: l.type
                    }));
                    displayData.allFields = Object.keys(result.items[0]);
                }

                showResult('approved-leagues-result', displayData);
            } catch (error) {
                console.error('GET APPROVED_LEAGUES Error:', error);
                showResult('approved-leagues-result', {
                    error: error.message,
                    stack: error.stack
                }, true);
            }
        }

        async function testGetWatchlist() {
            try {
                showInfo('get-result', '‚è≥ Loading watchlist...');
                
                const url = new URL(BASE_URL);
                url.searchParams.set('resource', 'watchlist');
                url.searchParams.set('action', 'getAll');
                url.searchParams.set('apiKey', API_KEY);

                console.log('GET Request URL:', url.toString());

                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'omit',
                    redirect: 'follow'
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);

                showResult('get-result', {
                    status: response.status,
                    statusText: response.statusText,
                    data: result,
                    itemCount: result.items?.length || 0
                });
            } catch (error) {
                console.error('GET Error:', error);
                showResult('get-result', {
                    error: error.message,
                    stack: error.stack
                }, true);
            }
        }

        async function testAddWatchlist() {
            try {
                showInfo('add-result', '‚è≥ Adding to watchlist...');

                const payload = {
                    apiKey: API_KEY,
                    resource: 'watchlist',
                    action: 'create',
                    data: [{
                        match_id: document.getElementById('add-match-id').value,
                        date: document.getElementById('add-date').value,
                        league: document.getElementById('add-league').value,
                        home_team: document.getElementById('add-home').value,
                        away_team: document.getElementById('add-away').value,
                        kickoff: document.getElementById('add-kickoff').value,
                        mode: document.getElementById('add-mode').value,
                        priority: parseInt(document.getElementById('add-priority').value) || 3,
                        custom_conditions: document.getElementById('add-conditions').value || '',
                        status: 'active'
                    }]
                };

                console.log('POST Request URL:', BASE_URL);
                console.log('POST Request Body:', JSON.stringify(payload, null, 2));

                const response = await fetch(BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(payload)
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Response data:', result);

                showResult('add-result', {
                    status: response.status,
                    statusText: response.statusText,
                    data: result,
                    insertedCount: result.insertedCount
                });
            } catch (error) {
                console.error('ADD Error:', error);
                showResult('add-result', {
                    error: error.message,
                    stack: error.stack
                }, true);
            }
        }

        async function testDeleteWatchlist() {
            try {
                showInfo('delete-result', '‚è≥ Deleting from watchlist...');

                const idsInput = document.getElementById('delete-ids').value;
                const ids = idsInput.split(',').map(id => id.trim()).filter(id => id);

                if (ids.length === 0) {
                    showResult('delete-result', { error: 'No IDs provided' }, true);
                    return;
                }

                const payload = {
                    apiKey: API_KEY,
                    resource: 'watchlist',
                    action: 'delete',
                    ids: ids
                };

                console.log('DELETE Request URL:', BASE_URL);
                console.log('DELETE Request Body:', JSON.stringify(payload, null, 2));

                const response = await fetch(BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(payload)
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Response data:', result);

                showResult('delete-result', {
                    status: response.status,
                    statusText: response.statusText,
                    data: result,
                    deletedCount: result.deletedCount
                });
            } catch (error) {
                console.error('DELETE Error:', error);
                showResult('delete-result', {
                    error: error.message,
                    stack: error.stack
                }, true);
            }
        }

        async function runFullTest() {
            const resultEl = document.getElementById('batch-result');
            resultEl.style.display = 'block';
            resultEl.className = 'result info';
            
            let log = 'üöÄ Starting full test sequence...\n\n';
            resultEl.textContent = log;

            try {
                // Step 1: GET initial
                log += '1Ô∏è‚É£ GET initial watchlist...\n';
                resultEl.textContent = log;
                
                const url1 = new URL(BASE_URL);
                url1.searchParams.set('resource', 'watchlist');
                url1.searchParams.set('action', 'getAll');
                url1.searchParams.set('apiKey', API_KEY);
                
                const r1 = await fetch(url1.toString(), {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    mode: 'cors',
                    credentials: 'omit',
                    redirect: 'follow'
                });
                const d1 = await r1.json();
                log += `   ‚úÖ Initial count: ${d1.items?.length || 0} items\n\n`;
                resultEl.textContent = log;
                await sleep(1000);

                // Step 2: ADD test item
                log += '2Ô∏è‚É£ ADD test item (BATCH_TEST_' + Date.now() + ')...\n';
                resultEl.textContent = log;
                
                const testMatchId = 'BATCH_TEST_' + Date.now();
                const addPayload = {
                    apiKey: API_KEY,
                    resource: 'watchlist',
                    action: 'create',
                    data: [{
                        match_id: testMatchId,
                        date: '2025-11-26',
                        league: 'Test League',
                        home_team: 'Test Home',
                        away_team: 'Test Away',
                        kickoff: '20:00',
                        mode: 'LIVE',
                        priority: 3,
                        custom_conditions: '',
                        status: 'active'
                    }]
                };
                
                const r2 = await fetch(BASE_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(addPayload)
                });
                const d2 = await r2.json();
                log += `   ‚úÖ Inserted: ${d2.insertedCount} item(s)\n\n`;
                resultEl.textContent = log;
                await sleep(1000);

                // Step 3: GET after add
                log += '3Ô∏è‚É£ GET watchlist after ADD...\n';
                resultEl.textContent = log;
                
                const r3 = await fetch(url1.toString(), {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    mode: 'cors',
                    credentials: 'omit',
                    redirect: 'follow'
                });
                const d3 = await r3.json();
                log += `   ‚úÖ Count after add: ${d3.items?.length || 0} items\n\n`;
                resultEl.textContent = log;
                await sleep(1000);

                // Step 4: DELETE test item
                log += '4Ô∏è‚É£ DELETE test item...\n';
                resultEl.textContent = log;
                
                const deletePayload = {
                    apiKey: API_KEY,
                    resource: 'watchlist',
                    action: 'delete',
                    ids: [testMatchId]
                };
                
                const r4 = await fetch(BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(deletePayload)
                });
                const d4 = await r4.json();
                log += `   ‚úÖ Deleted: ${d4.deletedCount} item(s)\n\n`;
                resultEl.textContent = log;
                await sleep(1000);

                // Step 5: GET final
                log += '5Ô∏è‚É£ GET final watchlist...\n';
                resultEl.textContent = log;
                
                const r5 = await fetch(url1.toString(), {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    mode: 'cors',
                    credentials: 'omit',
                    redirect: 'follow'
                });
                const d5 = await r5.json();
                log += `   ‚úÖ Final count: ${d5.items?.length || 0} items\n\n`;
                
                log += 'üéâ FULL TEST COMPLETED SUCCESSFULLY!\n';
                log += `\nSummary:\n`;
                log += `  ‚Ä¢ Initial: ${d1.items?.length || 0} items\n`;
                log += `  ‚Ä¢ Added: ${d2.insertedCount} item(s)\n`;
                log += `  ‚Ä¢ After add: ${d3.items?.length || 0} items\n`;
                log += `  ‚Ä¢ Deleted: ${d4.deletedCount} item(s)\n`;
                log += `  ‚Ä¢ Final: ${d5.items?.length || 0} items\n`;
                
                resultEl.className = 'result success';
                resultEl.textContent = log;

            } catch (error) {
                log += `\n‚ùå ERROR: ${error.message}\n`;
                log += `\nStack: ${error.stack}`;
                resultEl.className = 'result error';
                resultEl.textContent = log;
                console.error('Batch test error:', error);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Auto-load watchlist on page load
        window.addEventListener('load', () => {
            console.log('Page loaded - ready to test');
        });
    </script>
</body>
</html>
